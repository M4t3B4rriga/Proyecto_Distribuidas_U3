# ğŸª Inventory Management Service (`inventory-service`)

## ğŸš€ Overview
The `inventory-service` is responsible for **tracking and managing stock** of products in different stores. It ensures that:
- âœ… **Only `ADMIN` users can register and update stock.**
- âœ… **`EMPLOYEE` users can only view stock.**
- âœ… **No duplicate product entries exist for the same store.**
- âœ… **Stock updates when products are added or removed.**
- âœ… **JWT authentication is enforced to control access.**
- âœ… **Secure communication with `product-service` and `store-service` is established.**

---

## ğŸ”‘ **Role-Based Access Control (RBAC)**
The system has **two roles**:
1. **`ADMIN`** â€“ Has **full access** to manage inventory.
2. **`EMPLOYEE`** â€“ Can **only view** inventory.

### ğŸ›‚ **Access Permissions**
| **Role**  | **GET /inventory** | **POST /inventory** | **PUT /inventory** |
|-----------|------------------|------------------|------------------|
| **ADMIN** | âœ… Allowed | âœ… Allowed | âœ… Allowed |
| **EMPLOYEE** | âœ… Allowed | âŒ Forbidden | âŒ Forbidden |

---

## ğŸ”§ **How It Works**
### ğŸ›  **1. Secure Authentication with JWT**
- Users authenticate through **`auth-service`**, which generates a **JWT token**.
- The token contains **user role (`ADMIN` or `EMPLOYEE`)**.
- Example JWT payload:
        ```json
        {
                        "sub": "admin@example.com",
                        "role": "ADMIN",
                        "exp": 1740668714,
                        "iat": 1740665114
        }
        ```

### ğŸ” **2. Authorization in inventory-service**
- Spring Security reads the JWT and extracts the role claim.
- Role-based permissions are enforced in `SecurityConfig.java`:
        ```java
        .requestMatchers(HttpMethod.GET, "/inventory/**").hasAnyRole("ADMIN", "EMPLOYEE")
        .requestMatchers(HttpMethod.POST, "/inventory").hasRole("ADMIN")
        .requestMatchers(HttpMethod.PUT, "/inventory/**").hasRole("ADMIN")
        ```

---

## ğŸ“ **API Usage Guide**

### ğŸ“Œ **1. ADMIN Can Add Inventory**

**Request:**
```
POST /inventory
Authorization: Bearer ADMIN_JWT_TOKEN
Content-Type: application/json
```

**Request Body:**
```json
{
                "storeId": 1,
                "productId": 1,
                "quantity": 50
}
```

**Expected Response (201 Created):**
```json
{
                "id": 1,
                "storeId": 1,
                "productId": 1,
                "quantity": 50
}
```

### ğŸ“Œ **2. EMPLOYEE Tries to Add Inventory (Forbidden âŒ)**

**Headers:**
```
Authorization: Bearer EMPLOYEE_JWT_TOKEN
```

**Expected Response (403 Forbidden):**
```json
{
                "error": "Forbidden"
}
```

### ğŸ“Œ **3. Prevent Duplicate Product Entry in Same Store**

**Request:**
```
POST /inventory
Authorization: Bearer ADMIN_JWT_TOKEN
```

**Request Body:**
```json
{
                "storeId": 1,
                "productId": 1,
                "quantity": 30
}
```

**Expected Response (409 Conflict):**
```json
{
                "error": "Conflict",
                "message": "Product already exists in the inventory of this store"
}
```

### ğŸ“Œ **4. ADMIN Updates Stock**

**Request:**
```
PUT /inventory/1/1?quantity=75
Authorization: Bearer ADMIN_JWT_TOKEN
```

**Expected Response (200 OK):**
```json
{
                "id": 1,
                "storeId": 1,
                "productId": 1,
                "quantity": 75
}
```

### ğŸ“Œ **5. EMPLOYEE Retrieves Inventory**

**Request:**
```
GET /inventory/1
Authorization: Bearer EMPLOYEE_JWT_TOKEN
```

**Expected Response (200 OK):**
```json
[
                {
                                "id": 1,
                                "storeId": 1,
                                "productId": 1,
                                "quantity": 75
                }
]
```

### ğŸ“Œ **6. EMPLOYEE Tries to Update Stock (Forbidden âŒ)**

**Request:**
```
PUT /inventory/1/1?quantity=100
Authorization: Bearer EMPLOYEE_JWT_TOKEN
```

**Expected Response (403 Forbidden):**
```json
{
                "error": "Forbidden"
}
```

---

## ğŸš€ **Conclusion**
- âœ… JWT authentication ensures secure access.
- âœ… Spring Security enforces role-based access control (RBAC).
- âœ… Only `ADMIN` can add and update inventory.
- âœ… `EMPLOYEE` can only view inventory.
- âœ… No duplicate product entries per store.
- âœ… Stock updates correctly when products are added or removed.

# ğŸš€ **Inventory Movements & Role-Based Authorization - Testing Guide**

## **ğŸ” Overview**
This update ensures **automated inventory movements** and **strict role-based access control**:
- âœ… **`EMPLOYEE` can update stock (ENTRY/EXIT).**
- âœ… **`ADMIN` can view all movements and metrics.**
- âŒ **`EMPLOYEE` cannot view movements or metrics.**
- âœ… **Every stock update automatically logs a movement.**

---

## **ğŸ›  How It Works**
### **ğŸ”¹ 1. Automated Inventory Movements**
- Every time stock is **added (`ENTRY`)** or **removed (`EXIT`)**, a movement is logged.
- Employees no longer need to **manually register movements**.
- The system **prevents negative stock exits**.

### **ğŸ”¹ 2. Role-Based Access Control**
| **Action** | **Admin** | **Employee** |
|------------|----------|-------------|
| Update Stock | âœ… Allowed | âœ… Allowed |
| View All Movements | âœ… Allowed | âŒ Forbidden |
| View Store Movements | âœ… Allowed | âŒ Forbidden |
| View Movement Metrics | âœ… Allowed | âŒ Forbidden |

---

## **ğŸ›  Testing API Endpoints**
### ğŸ“Œ **1. `EMPLOYEE` Registers an Inventory Entry (`ENTRY`)**
#### **ğŸ“Œ Request**
```http
PUT http://localhost:8083/inventory/1/1?quantity=20&userId=100&movementType=ENTRY
Authorization: Bearer EMPLOYEE_JWT_TOKEN
```

**Expected Response (200 OK):**
```json
{
        "id": 1,
        "storeId": 1,
        "productId": 1,
        "quantity": 70
}
```

**Check Movement Log:**
```sql
SELECT * FROM inventory_movements WHERE store_id = 1 AND product_id = 1;
```

âœ… An ENTRY movement should be logged.

### ğŸ“Œ **2. EMPLOYEE Registers an Inventory Exit (EXIT)**

**Request:**
```http
PUT http://localhost:8083/inventory/1/1?quantity=10&userId=100&movementType=EXIT
Authorization: Bearer EMPLOYEE_JWT_TOKEN
```

**Expected Response (200 OK):**
```json
{
        "id": 1,
        "storeId": 1,
        "productId": 1,
        "quantity": 60
}
```

**Check Movement Log:**
```sql
SELECT * FROM inventory_movements WHERE store_id = 1 AND product_id = 1;
```

âœ… An EXIT movement should be logged.

### ğŸ“Œ **3. EMPLOYEE Tries to View Movements (âŒ Forbidden)**

**Request:**
```http
GET http://localhost:8083/inventory/movements
Authorization: Bearer EMPLOYEE_JWT_TOKEN
```

**Expected Response (403 Forbidden):**
```json
{
        "error": "Forbidden"
}
```

**Check Logs:**
```sh
tail -f logs/spring-boot.log
```

âœ… Logs should confirm that access was denied.

### ğŸ“Œ **4. ADMIN Retrieves All Movements (âœ… Allowed)**

**Request:**
```http
GET http://localhost:8083/inventory/movements
Authorization: Bearer ADMIN_JWT_TOKEN
```

**Expected Response (200 OK):**
```json
[
        {
                "id": 1,
                "storeId": 1,
                "productId": 1,
                "userId": 100,
                "quantity": 20,
                "movementType": "ENTRY",
                "movementDate": "2025-02-27T14:30:00"
        },
        {
                "id": 2,
                "storeId": 1,
                "productId": 1,
                "userId": 100,
                "quantity": 10,
                "movementType": "EXIT",
                "movementDate": "2025-02-27T14:35:00"
        }
]
```

**Check Logs:**
```sh
tail -f logs/spring-boot.log
```

âœ… Logs should confirm an ADMIN accessed movements.

### ğŸ“Œ **5. ADMIN Retrieves Movement Metrics (âœ… Allowed)**

**Request:**
```http
GET http://localhost:8083/inventory/movements/metrics
Authorization: Bearer ADMIN_JWT_TOKEN
```

**Expected Response (200 OK):**
```json
{
        "ENTRY": 5,
        "EXIT": 3
}
```

**Check Logs:**
```sh
tail -f logs/spring-boot.log
```

âœ… Logs should confirm an ADMIN accessed metrics.

### ğŸ“Œ **6. EMPLOYEE Tries to View Metrics (âŒ Forbidden)**

**Request:**
```http
GET http://localhost:8083/inventory/movements/metrics
Authorization: Bearer EMPLOYEE_JWT_TOKEN
```

**Expected Response (403 Forbidden):**
```json
{
        "error": "Forbidden"
}
```

**Check Logs:**
```sh
tail -f logs/spring-boot.log
```

âœ… Logs should confirm that access was denied.

